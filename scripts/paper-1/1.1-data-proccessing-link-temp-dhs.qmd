---
title: "Create a data frame that connects geo-coded DHS PSUs with climate data"
format: html
editor: visual
---

####### This script reads the geocoded PSU data from DHS and extracts daily gridded climate data for the past n years for each PSU. The result is a HUGE dataset where each PSU has n\*365 rows of data, where n is the number of years of climate data available.

# Load Packages

```{r load-packages, message=FALSE, warning=FALSE}
library(tidyverse)
```

# Step-1: Read geo-coded PSU data from DHS

## Load raw data

```{r read-geo}
library(sf)
df_dhs_geo_raw <- read_sf("../../common-datasets/india-nfhs-5/geographic-data/IAGE7AFL.shp")
nrow(df_dhs_geo_raw)
```

## Select relevant variables and filter out absurd geocodes

```{r select-and-filter-geo}
df_dhs_geo <- df_dhs_geo_raw %>% 
  dplyr::select(psu = DHSCLUST, state_name = ADM1NAME,
                district = DHSREGNA,
                rural = URBAN_RURA, 
                lat = LATNUM, long = LONGNUM, 
                starts_with("ALT")) %>% 
  dplyr::filter(!is.na(lat)) %>% 
  dplyr::filter(!is.na(long)) %>% 
  dplyr::filter(lat!=0 | long!=0) %>%                  #LAT=0 and LONG=0 are missing coordinates  
  dplyr::filter(lat <= -0.00005 | long >= 0.00005)      #missing obs. - remove
  
nrow(df_dhs_geo)
```

## Create a Spatial Points Dataframe for DHS PSUs

```{r}
library(sf)
df_dhs_psu_geo_spdf <- sf::as_Spatial(df_dhs_geo)
```

# Step-2: Get India Administrative Boundaries

## Load adm-1 for India

```{r}
library(geodata)
ind_adm_0 <- gadm(country = "IND", level = 0, path = "data/")
plot(ind_adm_0)
```

## Create a buffer around India

```{r}
# First convert datatype
class(ind_adm_0)
ind_adm_0_sf <- sf::st_as_sf(ind_adm_0)
ind_adm_0_spdf <- sf::as_Spatial(ind_adm_0_sf)

# Add Buffer
library(rgeos)
ind_adm_0_buf <- gBuffer(ind_adm_0_spdf, width = 1)
plot(ind_adm_0_buf)
```

# Step-3: Merge the DHS data with Climate Data

## Merging with Temperature datasets for Multiple Years

```{r extract-t-max-data-for-all-PSUs}
library(raster)
setwd("../../common-datasets/india-temperature-data/noaa/tmax-2000-2022")
(a <- list.files(pattern ="\\.nc"))
# a <- a[c(2)]

df_psu_tmax = NULL

system.time(
 for (i in a){
    rd0 <- brick(i)                       #load the data in raster format
    #plot(rd0, 1)
    rd1 <- rotate(rd0)                    #convert the LONG from 0:360 to -180:180 degree 
    plot(rd1, 1)
    
    ## Restrict the spatial data to the country boundary 
    cd0 <- crop(x = rd1, y = ind_adm_0_buf)
    cd1 <- rasterize(x = ind_adm_0_buf, y = cd0)
    cd2 <- mask(x = cd0, mask = cd1)
    plot(cd2, 1)
    
   # Extract the climate data for each PSU location
    df1 <- raster::extract(cd2,   # raster layer cropped to the country boundary
           df_dhs_psu_geo_spdf,      # SPDF with centroids for buffer
           df=TRUE)    # return a dataframe

    # Add the PSU information
    df1 <- cbind(df_dhs_psu_geo_spdf@data, df1)
    
    # Pivot from wide to long
    df2 <- df1 %>%
    pivot_longer(
    cols = starts_with("X"),
    names_to = "date",
    values_to = "max_temp",
    values_drop_na = TRUE) %>% 
    mutate(date = as.Date(substring(date, 2), format = "%Y.%m.%d"))
    
    # bind dataframe to existing data
    df_psu_tmax <- bind_rows(df_psu_tmax, df2)
    
  }
)

head(df_psu_tmax)
dim(df_psu_tmax)
```

# Step-4: Save you work

## Identify files to delete

```{r}
ls()
```

## Delete Unnecessary files

```{r}
rm(a, i)
rm(cd0, cd1, cd2)
rm(df_dhs_geo_raw, df_dhs_geo)
rm(df1, df2)
rm(ind_adm_0_buf, ind_adm_0_read, ind_adm_0_sf, ind_adm_0_spdf)
rm(rd0, rd1)
```

## Save Image

```{r}
system.time(
  save.image(file='save-point-dhs-psu-temp-merged.RData')
)
```
